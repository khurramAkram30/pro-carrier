import { CreateLabelRequest, DimensionUnit } from '@shipengine/connect-carrier-api';
import { CheckPackagesMaxDimensions } from '../../../../../src/validations';

describe('Package dimensions validator tests', function () {

    let request: CreateLabelRequest;

    beforeEach(() => {
        request = {
            service_code: 'HOME',
            ship_datetime: '2023-04-01T14:15:22Z',
            is_return_label: false,
            packages: [
                {
                    dimension_details: {
                        dimensions_in_centimeters: {
                            length: 4,
                            width: 4,
                            height: 15
                        },
                        dimensions_in_inches: {
                            length: 10,
                            width: 10,
                            height: 45
                        },
                        source_dimension_unit: DimensionUnit.Centimeters
                    },
                    insured_value: {
                        amount: '200',
                        currency: 'GBP'
                    }
                }
            ],
            ship_to: {
                name: 'ReceiverFullName',
                first_name: 'ReceiverFirstName',
                last_name: 'ReceiverLastName',
                email: 'receiver@test.com',
                phone_number: '883689148',
                company_name: 'ReceiverCompanyName',
                instructions: 'Some receiver instruction',
                address_lines: [
                    'Receiver address Line 1',
                    'Receiver address Line 2'
                ],
                city_locality: 'ReceiverCity',
                state_province: 'ReceiverProvince',
                postal_code: '67-100',
                country_code: 'PL'
            },
            ship_from: {
                name: 'SenderFullName',
                first_name: 'SenderFirstName',
                last_name: 'SenderLastName',
                email: 'Sender@test.com',
                phone_number: '883689148',
                company_name: 'SenderCompanyName',
                instructions: 'Some Sender instruction',
                address_lines: [
                    'Sender address Line 1',
                    'Sender address Line 2'
                ],
                city_locality: 'SenderCity',
                state_province: 'SenderProvince',
                postal_code: '67-100',
                country_code: 'PL'
            },
            transaction_id: '0fec1e58-b197-4052-99cf-2218496c5482'
        };
    });

    test.each([
        [100, 80, 60, DimensionUnit.Centimeters, [100, 80, 60]],
        [80, 100, 60, DimensionUnit.Centimeters, [100, 80, 60]],
        [60, 80, 100, DimensionUnit.Centimeters, [100, 80, 60]],
        [100, 80, 60, DimensionUnit.Inches, [100, 80, 60]],
        [80, 100, 60, DimensionUnit.Inches, [100, 80, 60]],
        [60, 80, 100, DimensionUnit.Inches, [100, 80, 60]]
    ])('CheckPackagesMaxDimensions, provided dimensions are correct with provided maximum values', (length: number, width: number, height: number, dimensionUnit: DimensionUnit, maximumAllowedValues: number[]) => {
        request.packages[0].dimension_details = {
            dimensions_in_centimeters: {
                length: length,
                width: width,
                height: height
            },
            dimensions_in_inches: {
                length: length,
                width: width,
                height: height
            },
            source_dimension_unit: dimensionUnit
        };

        const validator = new CheckPackagesMaxDimensions(maximumAllowedValues);

        const result = validator.validate(request);

        expect(result.hasError()).toBeFalsy();
    });

    test.each([
        [100, 80, 61, DimensionUnit.Centimeters, [100, 80, 60], 'For package number 1 shortest dimension must be lower than 60.'],
        [81, 100, 60, DimensionUnit.Centimeters, [100, 80, 60], 'For package number 1 middle dimension must be lower than 80.'],
        [60, 80, 101, DimensionUnit.Centimeters, [100, 80, 60], 'For package number 1 longest dimension must be lower than 100.'],
        [100, 80, 61, DimensionUnit.Inches, [100, 80, 60], 'For package number 1 shortest dimension must be lower than 60.'],
        [81, 100, 60, DimensionUnit.Inches, [100, 80, 60], 'For package number 1 middle dimension must be lower than 80.'],
        [60, 80, 101, DimensionUnit.Inches, [100, 80, 60], 'For package number 1 longest dimension must be lower than 100.']
    ])('CheckPackagesMaxDimensions, provided one dimension overextend provided maximum values', (length: number, width: number, height: number, dimensionUnit: DimensionUnit, maximumAllowedValues: number[], expectedErrorMessage: string) => {
        request.packages[0].dimension_details = {
            dimensions_in_centimeters: {
                length: length,
                width: width,
                height: height
            },
            dimensions_in_inches: {
                length: length,
                width: width,
                height: height
            },
            source_dimension_unit: dimensionUnit
        };

        const validator = new CheckPackagesMaxDimensions(maximumAllowedValues);

        const result = validator.validate(request);

        expect(result.getMessages()).toEqual(expectedErrorMessage);
    });

    test.each([
        [100, 81, 61, DimensionUnit.Centimeters, [100, 80, 60], 'For package number 1 shortest dimension must be lower than 60.\nFor package number 1 middle dimension must be lower than 80.'],
        [60, 81, 101, DimensionUnit.Inches, [100, 80, 60], 'For package number 1 middle dimension must be lower than 80.\nFor package number 1 longest dimension must be lower than 100.']
    ])('CheckPackagesMaxDimensions, provided two dimensions overextend provided maximum values', (length: number, width: number, height: number, dimensionUnit: DimensionUnit, maximumAllowedValues: number[], expectedErrorMessage: string) => {
        request.packages[0].dimension_details = {
            dimensions_in_centimeters: {
                length: length,
                width: width,
                height: height
            },
            dimensions_in_inches: {
                length: length,
                width: width,
                height: height
            },
            source_dimension_unit: dimensionUnit
        };

        const validator = new CheckPackagesMaxDimensions(maximumAllowedValues);

        const result = validator.validate(request);

        expect(result.getMessages()).toEqual(expectedErrorMessage);
    });

    test.each([
        [101, 81, 61, DimensionUnit.Centimeters, [100, 80, 60], 'For package number 1 shortest dimension must be lower than 60.\nFor package number 1 middle dimension must be lower than 80.\nFor package number 1 longest dimension must be lower than 100.'],
        [61, 81, 101, DimensionUnit.Inches, [100, 80, 60], 'For package number 1 shortest dimension must be lower than 60.\nFor package number 1 middle dimension must be lower than 80.\nFor package number 1 longest dimension must be lower than 100.']
    ])('CheckPackagesMaxDimensions, provided three dimensions overextend provided maximum values', (length: number, width: number, height: number, dimensionUnit: DimensionUnit, maximumAllowedValues: number[], expectedErrorMessage: string) => {
        request.packages[0].dimension_details = {
            dimensions_in_centimeters: {
                length: length,
                width: width,
                height: height
            },
            dimensions_in_inches: {
                length: length,
                width: width,
                height: height
            },
            source_dimension_unit: dimensionUnit
        };

        const validator = new CheckPackagesMaxDimensions(maximumAllowedValues);

        const result = validator.validate(request);

        expect(result.getMessages()).toEqual(expectedErrorMessage);
    });
});